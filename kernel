#!/bin/bash

STORED_CONFIG_FILE=/root/kernel/config

rebuild_post(){
	# rebuild third party kernel modules
	emerge -1 bbswitch nvidia-drivers
}

case $1 in
config)
	cp -rL /usr/src/linux /tmp/linux
	cd /tmp/linux
	cp "${STORED_CONFIG_FILE}" .config
	make oldconfig
	make menuconfig 
	dialog --yesno "Use new config?" 5 20 && cp .config "${STORED_CONFIG_FILE}"
	rm -rf /tmp/linux
	clear
	;;
rebuild)
	# remove existing kernel
	rm /boot/vmlinuz*
	rm /boot/config*
	rm /boot/System.map*
	rm -rf /lib/modules/*
	# clean source directory
	cp -rL /usr/src/linux /tmp/linux
	cd /tmp/linux
	# copy kernel config file
	cp "${STORED_CONFIG_FILE}" .config
	# build and install
	make -j5
	make install
	make modules_install
	# regenerate grub.cfg
	ln -s $(findmnt -ns / -o SOURCE) /dev/root #fix grub2-probe's error " cannot find a device for /"
	grub2-mkconfig -o /boot/grub2/grub.cfg
	# do rebuild_post
	rebuild_post
	rm -rf /tmp/linux
	;;
*)
	echo "Bad parameter" >&2
	exit 1
	;;
esac
